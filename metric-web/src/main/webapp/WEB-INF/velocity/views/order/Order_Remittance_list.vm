<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <link href="${rc.contextPath}/_resources/css/plugins/jqgrid/ui.jqgrid.css" rel="stylesheet">
    <script src="${rc.contextPath}/_resources/js/plugins/jqgrid/i18n/grid.locale-cn.js"></script>
    <script src="${rc.contextPath}/_resources/js/plugins/jqgrid/jquery.jqGrid.min.js"></script>
    <script src="${rc.contextPath}/_resources/js/plugins/layer/extend/layer.ext.js"></script>
    <script src="${rc.contextPath}/_resources/js/plugins/layer/laydate/laydate.js"></script>
</head>
<body class="gray-bg">
  <div class="ibox-content">
    <form role="form" id="queryForm" class="form-inline">
        <div class="form-group">
            <label>订单号:</label>
            <input type="text" name="orderId" class="form-control" >
            <label>用户名:</label>
            <input type="text" name="userName" class="form-control" >
            <label>真实姓名/公司名:</label>
            <input type="text" name="realName" class="form-control" >
            <label>汇款账户名:</label>
            <input type="text" name="remittanceName" class="form-control" >
        </div>
        <br>
        <div class="form-group">
            <label>汇款银行账号:</label>
            <input type="text" name="remittanceBank" class="form-control" >
            <label>手机号码:</label>
            <input type="text" name="remittanceTel" class="form-control">
            <label>状态</label>
            <select style="width:130px;height:33px" class="form-control" name="status">
               <option value="-1">请选择</option>
               <option value="0" selected="selected">待审核</option>
               <option value="1">通过并充值</option>
                <option value="2">拒绝</option>
            </select>
        </div>
        <br>
        <div class="form-group">
            <label>申请时间:</label>
            <input class="form-control layer-date" name="createdAtStart" placeholder="开始时间" onclick="laydate({istime: true, format: 'YYYY-MM-DD'})">
            <input class="form-control layer-date" name="createdAtEnd" placeholder="结束时间" onclick="laydate({istime: true, format: 'YYYY-MM-DD'})">
        </div>
        <button class="btn btn-white" type="button" onclick="searchList()"><i class="glyphicon glyphicon-search"></i>查询</button>
        <button class="btn btn-info" type="button" onclick="exportList()"><i class="glyphicon glyphicon-export"></i>导出</button>
    </form>
  </div>
  <div class="jqGrid_wrapper ">
     <table id="table_list_1"></table>
     <div id="pager_list_1"></div>
  </div>

<script>
    var ossDomain = '$!{ossDomain}';
   var exportList = function(){
        window.open("exportList.html?" + $('#queryForm').serialize());
   }
    function searchList(page){
         $("#table_list_1").jqGrid('setGridParam',{
              url:'listPageOrderRem.html',
              postData:getParams(),
              page:1
         }).trigger("reloadGrid");
    }
   $(document).ready(function () {
       $.jgrid.defaults.styleUI = 'Bootstrap';
       $('#table_list_1').jqGrid({
              url:'listPageOrderRem.html',
              datatype: "json",
              height: jqGridHeight,
              autowidth: true,
              shrinkToFit: true,
              rowNum: 20,
              viewrecords:true,
              postData:getParams(),
              rowList: [20, 30, 50],
              colNames: ['订单ID', '用户名','真实名称','汇款账户名','手机号码','银行账号','汇款凭证','汇款金额','汇款时间','状态','操作'],
              colModel: [
                 {
                    name: 'orderId',
                    width: 20
                 },
                 {
                    name: 'userName',
                    width: 10
                 },
                 {
                    name: 'realName',
                    width: 10
                  },
                  {
                      name: 'remittanceName',
                      width: 10
                  },
                  {
                     name: 'remittanceTel',
                     width: 10
                   },
                   {
                    name: 'remittanceBank',
                    width: 10
                  },
                   {
                      name: 'remittanceImg1',
                      width: 10,
                      formatter : function(value, options, rowObject) {
                          if(value==null||value==""){
                            return "";
                          }
                           return '<a href="javascript:void(0)" onclick="showImgBox(\'' + value + '\')" class="btn btn-primary"><i class="glyphicon glyphicon-eye-open"></i>查看</a>';
                      }
                  },
                  {
                      name: 'remittanceFee',
                      width: 10,
                      formatter:function(cellvalue){
                        return (parseFloat(cellvalue)/parseFloat(100)).toFixed(2);
                      }
                  },
                  {
                      name: 'createdAt',
                      width: 12,
                      formatter : function(value, options, rowObject) {
                      if(value==null||value==""){
                        return "";
                      }
                      var time = new Date(value);
                      return time.toLocaleString();
                      }
                  },
                   {
                   name: 'status',
                   width: 10,
                   formatter : function(value, row, index) {
                      if("0" == value){
                          return "待审核";
                       }else if("1" == value){
                          return "审核通过";
                      }else if("2" == value){
                          return "拒绝";
                      }else{
                          return "";
                      }
                    }
                  },
                  {
                      name : "opt",
                      width:15,
                      #if($permissionTool.hasPermission('audit.remittance.audit'))
                      formatter : function(value, options, rowObject) {
                          if(rowObject.status == '0'){
                              var html = '<a href="javascript:void(0)" onclick="updateAudit(\'' + rowObject.orderId + '\',\'' + rowObject.userId + '\',\'1\')" class="btn btn-success"><i class="glyphicon glyphicon-ok-circle"></i>通过</a>';
                              html += '&nbsp;<a href="javascript:void(0)" onclick="updateAudit(\'' + rowObject.orderId + '\',\'' + rowObject.userId + '\',\'2\')" class="btn btn-danger"><i class="glyphicon glyphicon-ban-circle"></i>拒绝</a>';
                              return html;
                          }else{
                              return "";
                          }
                      }
                      #end
                  }
              ],
              pager: "#pager_list_1"
         });
   });
    function updateAudit(orderId, userId, status){
        if("1" == status){
            layer.confirm('确认执行该操作？',{icon: 3, title:'汇款充值审核'}, function(){
                doAudit(orderId, userId, status, "");
            }, function(){
                layer.closeAll();
            });
        }else if("2" == status){
            layer.prompt({
                        formType: 2,
                        title: '请填写拒绝原因'
                    },
                    function(text, index){
                        doAudit(orderId, userId, status, text);
                    });
        }
    }
    function doAudit(orderId, userId, status, remark){
        $.ajax({
            type: "POST",
            url:"updateRemAudit.html?orderId=" + orderId + "&userId=" + userId + "&status=" + status + "&remark=" + remark,
            dataType:"json",
            success: function(data) {
                if(data.code == 1){
                    searchList();
                    closeLayer(data.msg);
                }else{
                    layer.msg(data.msg,failIcon);
                }
            }
        });
    }

    function  showImgBox(value) {
        var html='<div style="width:500px;height:300px"><img style="width:100%;height: 100%;" src="' + ossDomain + value + '"></div>';
        layer.open({
            type: 1,
            title: false,
	        area: ['500px', '300px'],
            closeBtn: 0,
            skin: 'layui-layer-nobg', //没有背景色
            shadeClose: true,
            content: html
        });

    }
   function getParams(){
        var data=$('#queryForm').serialize();
        data= decodeURIComponent(data,true);
        return formToJson(data);
    }
   function formToJson(data) {
       data=data.replace(/&/g,"\",\"");
       data=data.replace(/=/g,"\":\"");
       data="{\""+data+"\"}";
       var json =  eval('(' + data + ')');
       return json;
    }
</script>
</body>
</html>