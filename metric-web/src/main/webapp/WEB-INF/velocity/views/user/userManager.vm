<script src="${rc.contextPath}/_resources/js/jquery.md5.js"></script>
<script src="${rc.contextPath}/_resources/js/plugins/layer/laydate/laydate.js"></script>
<div class="ibox-content">
    <form role="form" id="userDataForm" class="form-inline">
        <div class="form-group">
            <div>
                <input type="hidden" name="userCatalog" value="$!{userCatalog}">
                <label>用户名:</label><input type="text" id="userName" name="userName" class="form-control">
                <label>手机号:</label><input type="text" id="userPhone" name="userPhone" class="form-control">
                <label>真实姓名:</label><input type="text" id="realName" name="realName" class="form-control">
                <label>状态:</label>
                <select data-placeholder="状态..." name="userStatus" class="form-control" style="height: 33px">
                    <option value="">请选择</option>
                    #foreach(${_status} in ${statusList})
                    <option value="$!{_status.value}" hassubinfo="true">$!{_status.name}</option>
                    #end
                </select>
            </div>
            <br>
            <div class="form-group">
                #if(${userCatalog}=='CHANNEL')
                <label>渠道类型:</label>
                <select data-placeholder="渠道类型..." name="userChannelIds" class="form-control" style="height: 33px">
                    <option value="">请选择</option>
                    #foreach(${_channelType} in ${channelTypeList})
                    <option value="$!{_channelType.value}" hassubinfo="true">$!{_channelType.name}</option>
                    #end
                </select>
                <label>身份类型:</label>
                <select data-placeholder="身份类型..." name="userRole" class="form-control" style="height: 33px">
                    <option value="">请选择</option>
                    #foreach(${_roleType} in ${roleTypeList})
                    <option value="$!{_roleType.value}" hassubinfo="true">$!{_roleType.name}</option>
                    #end
                </select>
                #end
                <label>注册时间</label>
                <input class="form-control layer-date" name="startDate" id="createdAtStart" placeholder="开始时间" onclick="laydate({istime: true, format: 'YYYY-MM-DD'})">
                -<input class="form-control layer-date" name="endDate" id="createdAtEnd" placeholder="结束时间" onclick="laydate({istime: true, format: 'YYYY-MM-DD'})">
            </div>
            <button class="btn btn-white" type="button" onclick="searchList()"><i
                    class="glyphicon glyphicon-search"></i>查询
            </button>
            #if($permissionTool.hasPermission('user.channel.add') && ${userCatalog}=='CHANNEL')
            <button class="btn btn-success" type="button" onclick="addUser('${userCatalog}')"><i
                    class="glyphicon glyphicon-plus"></i>新增用户
            </button>
            #elseif($permissionTool.hasPermission('user.advert.add') && ${userCatalog}=='ADVERT')
            <button class="btn btn-success" type="button" onclick="addUser('${userCatalog}')"><i
                    class="glyphicon glyphicon-plus"></i>新增用户
            </button>
            #end
            <button class="btn btn-info" type="button" onclick="exportList()"><i class="glyphicon glyphicon-export"></i>导出
            </button>
        </div>
    </form>
</div>
<div>
    <div class="jqGrid_wrapper">
        <table id="table_list_1"></table>
        <div id="pager_list_1"></div>
    </div>
</div>

<script>
  var userCatalog = '$!{userCatalog}';
   var exportList = function(){
        window.open("exportList.html?" + $('#userDataForm').serialize());
   }
  var searchList = function(){
       $('#table_list_1').jqGrid('setGridParam',{
            postData:getParams(),
            url:'userList.html',
            page:1
       }).trigger("reloadGrid");
   }

   function getParams(){
        var data=$('#userDataForm').serialize();
        data= decodeURIComponent(data,true);
        return formToJson(data);
    }
   function formToJson(data) {
       data=data.replace(/&/g,"\",\"");
       data=data.replace(/=/g,"\":\"");
       data="{\""+data+"\"}";
       var json =  eval('(' + data + ')');
       return json;
    }
   $(document).ready(function () {
       $("#createdAtStart").val(laydate.now(-7));
       $("#createdAtEnd").val(laydate.now());
       $.jgrid.defaults.styleUI = 'Bootstrap';
       $('#table_list_1').jqGrid({
              url:'userList.html',
              postData:getParams(),
              datatype: "json",
              height: jqGridHeight,
              autowidth: true,
              shrinkToFit: true,
              viewrecords:true,
              rowNum: 20,
              rowList: [20, 30, 50],
              colNames: ['用户名','真实名','手机号','身份类型','用户大类','推广/商务','状态','备注','创建时间','操作'],
              colModel: [
                 {
                    name: 'userName'
                 },
                 {
                    name: 'realName'
                 },
                 {
                       name: 'userPhone'
                  },
                 {
                       name: 'userRole',
                       formatter : function(value, row, index) {
                            if("PERSON" == value){
                                 return "个人";
                            }else if("BUSI" == value){
                                 return "企业";
                            }else if("ADMIN" == value){
                                 return "管理员";
                            }else {
                                return "未知";
                            }
                         }
                  },
                  {
                      name: 'userCatalog',
                       formatter : function(value, row, index) {
                          if("CHANNEL" == value){
                              return "渠道主";
                           }else if("ADVERT" == value){
                              return "广告主";
                          }else if("ADMIN" == value){
                              return "管理员";
                          }else{
                              return "未知";
                          }
                        }
                  },
                  {
                      name: 'promoterName'
                  },
                  {
                      name: 'userStatus',
                       formatter : function(value, row, index) {
                          if("INIT" == value){
                              return "新建";
                           }else if("AUDIT" == value){
                              return "待审核";
                          }else if("NORMAL" == value){
                              return "启用";
                          }else if("DISABLE" == value){
                              return "禁用";
                          }else{
                              return "未知";
                          }
                        }
                  },
                  {
                      name: 'userRemark'
                  },
                  {
                      name: 'createdAt',
                      formatter:formatDate
                  },
                  {
                      formatter:formatterOperHtml,
                      width: 260
                  }
              ],
              pager: "#pager_list_1"
         });
   });
   var formatterOperHtml = function(cellvalue, options, rowObject) {
       var h1 = '';
       #if($permissionTool.hasPermission('user.channel.status') && ${userCatalog}=='CHANNEL')
       if(rowObject.userStatus!='INIT'){
           var statusName = '禁用';
           var oper = 'DISABLE';
           if(rowObject.userStatus=='DISABLE'){
                statusName='启用';
                oper = 'ENABLE';
           }
           h1 = '<a href="javascript:enOrDisabledUser(\'' + rowObject.userName + '\',\'' + oper + '\',\'' + rowObject.appCode + '\')" class="btn btn-info ">' + statusName + '</a>';
       }
       #elseif($permissionTool.hasPermission('user.advert.status') && ${userCatalog}=='ADVERT')
       if(rowObject.userStatus!='INIT'){
           var statusName = '禁用';
           var oper = 'DISABLE';
           if(rowObject.userStatus=='DISABLE'){
                statusName='启用';
                oper = 'ENABLE';
           }
           h1 = '<a href="javascript:enOrDisabledUser(\'' + rowObject.userName + '\',\'' + oper + '\',\'' + rowObject.appCode + '\')" class="btn btn-info ">' + statusName + '</a>';
       }
       #end
       var h2 = '';
       #if($permissionTool.hasPermission('user.channel.update') && ${userCatalog}=='CHANNEL')
       h2 = '<a href="javascript:edit(\'' + rowObject.userName + '\',\'' + rowObject.appCode +  '\')" class="btn btn-primary "><i class="glyphicon glyphicon-pencil"></i>修改</a>';
	   #elseif($permissionTool.hasPermission('user.advert.update') && ${userCatalog}=='ADVERT')
	   h2 = '<a href="javascript:edit(\'' + rowObject.userName + '\',\'' + rowObject.appCode +  '\')" class="btn btn-primary "><i class="glyphicon glyphicon-pencil"></i>修改</a>';
	   #end
	   var h3 = '';
	   #if($permissionTool.hasPermission('user.channel.reset') && ${userCatalog}=='CHANNEL')
	   h3 = '<a href="javascript:resetPwd(\'' + rowObject.userName + '\',\'' + rowObject.appCode +  '\')" class="btn btn-primary "><i class="glyphicon glyphicon-pencil"></i>重置密码</a>';
	   #elseif($permissionTool.hasPermission('user.advert.reset') && ${userCatalog}=='ADVERT')
	   h3 = '<a href="javascript:resetPwd(\'' + rowObject.userName + '\',\'' + rowObject.appCode +  '\')" class="btn btn-primary "><i class="glyphicon glyphicon-pencil"></i>重置密码</a>';
	   #end
	   return  h2 + "&nbsp;&nbsp;" + h1 + "&nbsp;&nbsp;" + h3;
   }

    var edit = function(userName, appCode){
       layer.open({
         type: 2,
         area: ['800px', '500px'],
         fixed: false,
         maxmin: true,
         title: '编辑用户',
         content: 'edit.html?userName=' + userName + '&userCatalog=' + userCatalog + '&appCode=' + appCode
        });
    }
   var enOrDisabledUser = function(userName, oper, appCode){
        $.ajax({
            type: "POST",
            url:"enOrDisabledUser.html?userName=" + userName + "&oper=" + oper + "&appCode=" + appCode ,
            dataType:"json",
            success: function(data) {
                layer.msg(data.msg);
                searchList();
            }
        });
   }
   var resetPwd = function(userName, appCode){
        $.ajax({
            type: "POST",
            url:"resetPwd.html?userName=" + userName + "&appCode=" + appCode ,
            dataType:"json",
            success: function(data) {
                layer.msg(data.msg);
            }
        });
   }
   var addUser = function(userCatalog){
        layer.open({
             type: 2,
             area: ['800px', '500px'],
             fixed: false,
             maxmin: true,
             title: '新增用户',
             content: 'toAdd.html?userCatalog=' + userCatalog
        });
   }
   function getParams(){
        var data=$('#userDataForm').serialize();
        data= decodeURIComponent(data,true);
        return formToJson(data);
    }
   function formToJson(data) {
       data=data.replace(/&/g,"\",\"");
       data=data.replace(/=/g,"\":\"");
       data="{\""+data+"\"}";
       var json =  eval('(' + data + ')');
       return json;
    }

    function formatDate(cellvalue)   {
      var date = new Date(cellvalue);
        var y = date.getFullYear();
        var m = date.getMonth() + 1;
        m = m < 10 ? ('0' + m) : m;
        var d = date.getDate();
        d = d < 10 ? ('0' + d) : d;
        var h = date.getHours();
        h = h < 10 ? ('0' + h) : h;
        var minute = date.getMinutes();
        var second = date.getSeconds();
        minute = minute < 10 ? ('0' + minute) : minute;
        second = second < 10 ? ('0' + second) : second;
        return y + '-' + m + '-' + d+' '+h+':'+minute+':'+second;
    }
</script>