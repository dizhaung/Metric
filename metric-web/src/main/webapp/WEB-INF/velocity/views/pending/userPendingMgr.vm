<script src="${rc.contextPath}/_resources/js/jquery.md5.js"></script>
<script src="${rc.contextPath}/_resources/js/plugins/layer/laydate/laydate.js"></script>
<div class="ibox-content">
    <form role="form" id="userDataForm" class="form-inline">
        <div class="form-group">
            <label>用户名:</label>
            <input type="text" id="userName" name="userName" class="form-control">
            <label>手机号:</label>
            <input type="text" id="userPhone" name="userPhone" class="form-control">
            <label>渠道类型:</label>
            <select data-placeholder="渠道类型..." name="userChannelIds" class="form-control" style="height: 33px">
                <option value="">请选择</option>
                #foreach(${_channelType} in ${channelTypeList})
                <option value="$!{_channelType.value}" hassubinfo="true">$!{_channelType.name}</option>
                #end
            </select>
            <label>状态</label>
            <select data-placeholder="状态..." name="userInfoStatus" class="form-control" style="width:130px;height:33px">
                <option value="">请选择</option>
                <option value="INIT">新建</option>
                <option value="AUDIT" selected="selected">待审核</option>
                <option value="PASS">审核通过</option>
                <option value="REJECT">审核未通过</option>
            </select>
        </div>
        <br><br>
        <div class="form-group">
            <label>注册时间</label>
            <input class="form-control layer-date" name="startDate" id="createdAtStart" placeholder="开始时间"
                   onclick="laydate({istime: true, format: 'YYYY-MM-DD'})">
            <input class="form-control layer-date" name="endDate" id="createdAtEnd" placeholder="结束时间"
                   onclick="laydate({istime: true, format: 'YYYY-MM-DD'})">

            <button class="btn btn-white" type="button" onclick="searchList()"><i
                    class="glyphicon glyphicon-search"></i>查询
            </button>
            <button class="btn btn-success" type="button" onclick="addUser('${userCatalog}')"><i
                    class="glyphicon glyphicon-plus"></i>新增用户
            </button>
            <button class="btn btn-info" type="button" onclick="exportList()"><i class="glyphicon glyphicon-export"></i>导出
            </button>
        </div>
    </form>
</div>
<div>
    <div class="jqGrid_wrapper">
        <table id="table_list_1"></table>
        <div id="pager_list_1"></div>
    </div>
</div>

<script>
  var searchList = function(){
       $('#table_list_1').jqGrid('setGridParam',{
            url:'userList.html',
            postData:getParams(),
            page:1
       }).trigger("reloadGrid");
   }
   var exportList = function(){
        window.open("exportList.html?" + $('#userDataForm').serialize());
   }

   $(document).ready(function () {
       $("#createdAtStart").val(laydate.now(-7));
       $("#createdAtEnd").val(laydate.now());
       $.jgrid.defaults.styleUI = 'Bootstrap';
       $('#table_list_1').jqGrid({
              url:'userList.html',
              postData:getParams(),
              datatype: "json",
              height: jqGridHeight,
              autowidth: true,
              shrinkToFit: true,
              rownumbers:true,
              viewrecords:true,
              rowNum: 20,
              rowList: [20, 30, 50],
              colNames: ['用户名称','企业/个人名称','身份类型','电话','推广员','状态','注册时间','审核人','审核时间','操作'],
              colModel: [
                 {
                    name: 'userName',
                    width: 10
                 },
                 {
                    name: 'realName',
                    width: 10
                 },
                 {
                       name: 'userRole',
                       width: 10,
                       formatter : function(value, row, index) {
                          if("PERSON" == value){
                              return "个人";
                           }else if("BUSI" == value){
                              return "企业";
                          }else if("ADMIN" == value){
                              return "管理员";
                          }else{
                              return "";
                          }
                        }
                  },
                 {
                       name: 'userPhone',
                       width: 10
                  },
                  {
                      name: 'promoterName',
                      width: 10
                  },
                  {
                      name: 'userInfoStatus',
                      width: 10,
                       formatter : function(value, row, index) {
                          if("INIT" == value){
                              return "新建";
                           }else if("AUDIT" == value){
                              return "待审核";
                          }else if("PASS" == value){
                              return "审核通过";
                          }else if("REJECT" == value){
                              return "审核未通过";
                          }else{
                              return "";
                          }
                        }
                  },
                  {
                      name: 'createdAt',
                      width: 12,
                      formatter:formatDate
                  },
                  {
                      name: 'auditUserName',
                      width: 10
                  },
                  {
                      name: 'auditTimeStr',
                      width: 12
                  },
                  {
                      width: 10,
                      formatter:formatterOperHtml
                  }
              ],
              pager: "#pager_list_1"
         });
   });
   var formatterOperHtml = function(cellvalue, options, rowObject) {
       var htm = '';
       #if($permissionTool.hasPermission('audit.user.audit'))
       if(rowObject.userStatus=='AUDIT' && rowObject.userInfoStatus=='AUDIT'){
       if(rowObject.userStatus=='NORMAL' && rowObject.userInfoStatus=='AUDIT'){
           htm = '<a href="javascript:pending(\'' + rowObject.userName + '\')" class="btn btn-primary "><i class="glyphicon glyphicon-pencil"></i>审核</a>\t';
       }
       htm = htm + '<a href="javascript:view(\'' + rowObject.userName + '\')" class="btn btn-primary "><i class="glyphicon glyphicon-pencil"></i>详情</a>';
       #end
	   return htm;
   }

    var pending = function(userName){
       layer.open({
         type: 2,
         area: ['800px', '500px'],
         fixed: false,
         title: '用户详情',
         maxmin: true,
         content: 'toUserPending.html?userName=' + userName
        });
    }
    var view = function(userName){
       layer.open({
         type: 2,
         area: ['800px', '500px'],
         fixed: false,
         title: '用户详情',
         maxmin: true,
         content: 'toUserDetail.html?userName=' + userName
        });
    }
   function getParams(){
        var data=$('#userDataForm').serialize();
        data= decodeURIComponent(data,true);
        return formToJson(data);
    }
   function formToJson(data) {
       data=data.replace(/&/g,"\",\"");
       data=data.replace(/=/g,"\":\"");
       data="{\""+data+"\"}";
       var json =  eval('(' + data + ')');
       return json;
    }
    function formatDate(cellvalue)   {
      var date = new Date(cellvalue);
        var y = date.getFullYear();
        var m = date.getMonth() + 1;
        m = m < 10 ? ('0' + m) : m;
        var d = date.getDate();
        d = d < 10 ? ('0' + d) : d;
        var h = date.getHours();
        h = h < 10 ? ('0' + h) : h;
        var minute = date.getMinutes();
        var second = date.getSeconds();
        minute = minute < 10 ? ('0' + minute) : minute;
        second = second < 10 ? ('0' + second) : second;
        return y + '-' + m + '-' + d+' '+h+':'+minute+':'+second;
    }

</script>