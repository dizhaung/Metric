<script src="${rc.contextPath}/_resources/js/plugins/layer/extend/layer.ext.js"></script>
<script src="${rc.contextPath}/_resources/js/jquery.md5.js"></script>
<div class="ibox-content">
    <form role="form" class="form-inline">
        <div class="form-group">
            <label>用户名:</label><input type="text" id="userName" class="form-control">
            <label>申请人:</label><input type="text" id="applyUserName" class="form-control">
            <label>变更类型</label>
            <div class="input-group">
              <select class="form-control" style="width:130px;height:33px" id="orderType">
               <option value="">请选择</option>
               <option value="1">返点</option>
               <option value="2">扣点</option>
             </select>
            </div>
            <label>状态</label>
              <div class="input-group">
               <select class="form-control" style="width:130px;height:33px" id="status">
                  <option value="">请选择</option>
                   #foreach($item in $!{status.entrySet()})
                     <option value="$!{item.key}" #if($!{item.key} == '0') selected="selected" #end>$!{item.value}</option>
                   #end
               </select>
             </div>
            </br></br>
            <div class="form-group">
                 <label>申请时间</label>
                 <input class="form-control layer-date" id="startDate" placeholder="开始时间" onclick="laydate({istime: true, format: 'YYYY-MM-DD'})">
                 <input class="form-control layer-date" id="endDate" placeholder="结束时间" onclick="laydate({istime: true, format: 'YYYY-MM-DD'})">
             </div>
            <button class="btn btn-white" type="button" onclick="searchList('1')"><i class="glyphicon glyphicon-search"></i>查询</button>
             #if($permissionTool.hasPermission('user.BalanceApply.new'))
               <button class="btn btn-success" type="button" onclick="addApply()"><i class="glyphicon glyphicon-plus"></i>新建调整</button>
             #end
             #if($permissionTool.hasPermission('user.BalanceApply.audit'))
               <button class="btn btn-success" type="button" onclick="updateAuditBatch('1')"><i class="glyphicon glyphicon-ok-circle"></i>批量通过</button>
               <button class="btn btn-danger" type="button" onclick="updateAuditBatch('2')"><i class="glyphicon glyphicon-ban-circle"></i>批量拒绝</button>
             #end
            <button class="btn btn-info" type="button" onclick="exportData()"><i class="glyphicon glyphicon-export"></i>导出</button>
        </div>
    </form>
  </div>
  <div class="jqGrid_wrapper">
        <table id="table_list_1"></table>
        <div id="pager_list_1"></div>
   </div>
 <script>
  function searchList(page){
       $("#table_list_1").jqGrid('setGridParam',{
            url:'applyJson.html?'+getParams(),
            page:page
       }).trigger("reloadGrid");
   }
   function getParams(){
      var userName=$("#userName").val();
      var applyUserName=$("#applyUserName").val();
      var status=$("#status").val();
      var orderType=$("#orderType").val();
      var startDate=$("#startDate").val();
      var endDate=$("#endDate").val();
      if("" != endDate){
        endDate = endDate + ' 23:59:59';
      }
      return "userName="+userName+"&applyUserName="+applyUserName+"&status="+status+"&orderType="+orderType+"&startDate="+startDate+"&endDate="+endDate;
   }

   $(document).ready(function () {
       $("#startDate").val(laydate.now(-7));
       $("#endDate").val(laydate.now());
       $.jgrid.defaults.styleUI = 'Bootstrap';
       $('#table_list_1').jqGrid({
              url:'applyJson.html?'+getParams(),
              datatype: "json",
              height: jqGridHeight,
              autowidth: true,
              shrinkToFit: true,
              viewrecords:true,
              rowNum: 20,
              rowList: [20, 30, 50],
              viewrecords : true,
              multiselect :true,
              colNames: ['申请记录id','用户名','真实姓名','变更类型','变更原因','变更金额(￥)','状态','申请人','申请时间','审核人','审核时间','备注','操作'],
              colModel: [
                 {
                    name: 'balanceAplId',
                    width: 10,
                    hidden:true
                 },
                 {
                   name: 'userName',
                   width: 10
                 },
                 {
                    name: 'userRelName',
                    width: 10
                 },
                  {
                     name: 'orderType',
                     width: 10
                  },
                  {
                     name: 'orderItem',
                     width: 10
                  },
                 {
                      name: 'money',
                      width: 10
                  },
                  {
                     name: 'statusName',
                     width: 10
                  },
                  {
                     name: 'applyUserName',
                     width: 10
                   },
                  {
                      name: 'createdAtStr',
                      width: 12
                  },
                  {
                      name: 'auditUserName',
                      width: 10
                  },
                 {
                      name: 'auditTimeStr',
                      width: 12
                 },
                 {
                      name: 'remark',
                      width: 10
                  },
                 {
                     name : "opt",
                     width:12,
                     formatter : function(value, options, rowObject) {
                      #if($permissionTool.hasPermission('user.BalanceApply.audit'))
                        if(rowObject.status == '0'){
                          var html = '<a href="javascript:void(0)" onclick="updateAudit(\'' + rowObject.balanceAplId + '\',\'1\')" class="btn btn-success"><i class="glyphicon glyphicon-ok-circle"></i>通过</a>';
                          html += '&nbsp;&nbsp;<a href="javascript:void(0)" onclick="updateAudit(\'' + rowObject.balanceAplId + '\',\'2\')" class="btn btn-danger"><i class="glyphicon glyphicon-ban-circle"></i>拒绝</a>';
                          return html;
                        }else{
                          return "";
                        }
                     #else
                       return "";
                     #end
                   }
                 }
              ],
              pager: "#pager_list_1"
         });
   });
   function updateAudit(applyIds, status){
       if("1" == status){
          layer.prompt({
              formType: 1,
              title: '输入系统密码，并确认'
           },
           function(text, index){
              doAudit(applyIds,status,'',$.md5(text));
           });
        }else if("2" == status){
         layer.prompt({
            formType: 2,
            title: '请填写拒绝原因'
         },
         function(text, index){
            doAudit(applyIds,status,text,'');
         });
       }
    }
    function updateAuditBatch(status){
       var selIds = $("#table_list_1").jqGrid("getGridParam", "selarrrow");
       if(selIds.length<=0){
            layer.msg("请选择审核数据",failIcon);
            return;
       }
       var applyIds = new Array();
       var myGrid = $("#table_list_1");
       for(var i=0;i<selIds.length;i++){
          applyIds.push(myGrid.jqGrid('getCell',selIds[i],"balanceAplId"))
       }
       updateAudit(applyIds.join(","),status);
    }
    function doAudit(applyIds, status, remark, payPwd){
       $.ajax({
          type: "POST",
          url:"updateAudit.html?applyIds="+applyIds+"&status="+status+"&remark="+remark+"&payPwd="+payPwd,
          dataType:"json",
          success: function(data) {
             if(data.code == 1){
                searchList();
                closeLayer(data.msg);
             }else{
               searchList();
               layer.msg(data.msg,failIcon);
            }
         }
       });
     }
     function addApply(){
       var width = (document.body.clientWidth-220)+"px";
       layer.open({
         type: 2,
         area: [width, '100%'],
         offset: ['0px', '220px'],
         fixed: false,
         title: '新建调整',
         maxmin: true,
         shadeClose: true,
         content: 'editApply.html'
        });
    }
   function exportData(){
        window.location.href="export.html?"+getParams();
    }
</script>
</html>