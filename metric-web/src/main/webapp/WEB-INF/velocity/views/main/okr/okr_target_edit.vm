<link href="${rc.contextPath}/_resources/css/bootstrap-select.css" rel="stylesheet">
<link href="${rc.contextPath}/_resources/css/jquery/select2.min.css" rel="stylesheet">
<script src="${rc.contextPath}/_resources/js/bootstrap-select.js"></script>
<script src="${rc.contextPath}/_resources/js/jquery.select2.full.js"></script>
<div class="ibox-content">
   <form class="form-horizontal" id="form1">
         <div class="form-group">
             <label class="col-sm-3 control-label">目标名称：</label>
             <div class="col-sm-8">
                 <input type="hidden" name="targetId" value="$!{target.targetId}">
                 <input type="text" class="form-control" name="targetName" value="$!{target.targetName}" style="width:400px">
             </div>
         </div>
          <div class="form-group">
                      <label class="col-sm-3 control-label">关键指标：</label>
                       <button type="button" id="delButton" class="btn btn-danger"><i class="glyphicon glyphicon-ok">删除 </i>
                      </button>
                       <button type="button" id="addButton" class="btn btn-success">添加</i></button>
                      <div class="col-sm-8" style="width:430px">
                       <select name="targetItemDtoLists[0].quotaCode" class="form-control">
                          #foreach($item in ${quotas})
                             #if($!{target.quotaCode} == $!{item.quotaCode})
                                <option value="$!{item.quotaCode}" selected="selected">$!{item.quotaName}</option>
                              #else
                                <option value="$!{item.quotaCode}">$!{item.quotaName}</option>
                              #end
                           #end
                       </select>
                        <input type="text" class="form-control" onchange="if(!/^\d+(\.\d+)?$/.test(this.value)){alert('只能输入数字');this.value='';}" placeholder="目标值" name="targetItemDtoLists[0].targetValue" value="">
                         <input type="text" class="form-control" onchange="if(!/^\d+(\.\d+)?$/.test(this.value)){alert('只能输入数字');this.value='';}" placeholder="权重值(所有关联权重值之和必须为100)" name="targetItemDtoLists[0].weight" value="">
                    </div>
                  </div>
         <div class="form-group">
              <label class="col-sm-3 control-label">所属业务：</label>
              <div class="col-sm-8">
                     <select style="width:400px;height:30px"  name="busiDomain">
                                        <option value="" >请选择所属业务</option>
                                       #foreach($item in $bizInfo)
                                       <option #if($!target.busiDomain == $!{item.value}) selected=\"selected\"  #end value="$!{item.value}">$!{item.name}</option>
                                       #end
                      </select>
              </div>
          </div>
           <div class="form-group">
                        <label class="col-sm-3 control-label">关注人：</label>
                        <div class="col-sm-8">
                            <select id="userName" multiple="multiple" style="width:250px" name="userId" data-userId="$!{target.businessId}" class="form-control">
                                           <option value="">目标关注人(可多选)</option>
                             </select>
                        </div>
                    </div>
         <div class="form-group">
                      <label class="col-sm-3 control-label">目标时间：</label>
                      <div class="col-sm-8">
                           <input class="form-control layer-date" value="$!date.format('yyyy-MM-dd',$!{target.targetStartTime})" name="startDate" id="targetStartTime" placeholder="开始时间" onclick="laydate({istime: true, format: 'YYYY-MM-DD'})">
                           -<input class="form-control layer-date" value="$!date.format('yyyy-MM-dd',$!{target.targetEndTime})" name="endDate" id="targetEndTime" placeholder="结束时间" onclick="laydate({istime: true, format: 'YYYY-MM-DD'})">
                      </div>
          </div>
          <div class="form-group">
                       <label class="col-sm-3 control-label">关联看板：</label>
                       <div class="col-sm-8">
                           <select style="width:400px;height:30px"  name="boardId">
                             #foreach($item in ${boards})
                                <option value="$!{item.boardId}" #if($!item.boardId == $!target.boardId) selected="selected" #end>$!{item.boardName}</option>
                             #end
                           </select>
                       </div>
           </div>
        <div align="center">
           <button class="btn btn-success" type="button" onclick="saveTarget()"><i class="glyphicon glyphicon-ok"></i>保存</button>
           <button class="btn btn-white" type="button" onclick="parent.closeLayer()"><i class="glyphicon glyphicon-remove"></i>返回</button>
        </div>
     </form>
 </div>
 <script>
 var index=1;
  function saveTarget(){
     $.ajax({
        type: "POST",
        url:"saveTarget.html",
        dataType:"json",
        data:$('#form1').serialize(),
        success: function(data) {
           if(data.code == 1){
               parent.searchList();
               parent.closeLayer(data.msg);
            }else{
              parent.layer.msg(data.msg,failIcon);
            }
        }
    });
  }

  $("#userName").select2({
                    ajax: {
                      url: "${rc.contextPath}/admin/ajaxGetData/getUserByName.html",
                      dataType: 'json',
                      delay: 250,
                      data: function (params) {
                        return {
                          q: params.term, // search term
                          page: params.page
                        };
                      },
                      processResults: function (data, params) {
                       params.page = params.page || 1;
                      var itemList = [];
                       for(item in data){
                           itemList.push({id:data[item].userId, text:data[item].userName})
                       }
                       return {
                           results: itemList,
                           pagination: {
                                     more: (params.page * 30) < data.total_count
                             }
                       };
                      },
                      cache: true
                    },
                    escapeMarkup: function (markup) { return markup; }, // let our custom formatter work
                    minimumInputLength: 1,
                    allowClear: true,
                     placeholder:'请输入用户名称',//默认文字提示
                    formatResult: function formatRepo(repo){return repo.text;}, // 函数用来渲染结果
                    formatSelection: function formatRepoSelection(repo){return repo.text;} // 函数用于呈现当前的选择
          });


  $(document).ready(function() {
          $.ajax({
                 type:"POST",
                 url:"${rc.contextPath}/admin/ajaxGetData/getUserInfoByUserId.html",
                 data:{userId:$("[name='userId']").attr("data-userId")},
                 datatype:  "json",
                 success:function(data){
                    data = eval('(' + data + ')');
                    if(data && data.promoterId){
                         $("#businessId").empty();
                         var str='<option value="'+data.userId+'">'+data.userName+'</option>'
                         $("#businessId").append(str);
                         $("#select2-businessId-container").text(data.userName)
                     }
                 } ,
                 error: function(){
                     //请求出错处理
                 }
         });
     });
     $("#addButton").click(function(){
          var html="";
          html=html+' <div class="col-sm-8" style="width:430px"><select name="targetItemDtoLists[';
          html=html+index;
          html=html+'].quotaCode" class="form-control">';
                #foreach($item in ${quotas})
                       #if($!{target.quotaCode} == $!{item.quotaCode})
                        html=html+'<option value="$!{item.quotaCode}" selected="selected">$!{item.quotaName}</option>';
                      #else
                         html=html+'<option value="$!{item.quotaCode}">$!{item.quotaName}</option>';
                      #end
                    #end
          html=html+'</select><input type="text" class="form-control" onchange="if(!/^\\d+(\\.\\d+)?$/.test(this.value)){alert(\'只能输入数字\');this.value=\'\';}" placeholder="目标值" name="targetItemDtoLists[';
          html=html+index;
          html=html+'].targetValue" value="">';
          html=html+'<input type="text" class="form-control" onchange="if(!/^\\d+(\\.\\d+)?$/.test(this.value)){alert(\'只能输入数字\');this.value=\'\';}" placeholder="权重值(所有关联权重值之和必须为100)" name="targetItemDtoLists[';
          html=html+index;
          html=html+'].weight" value="">';
          html=html+'</div>';
          $(this).parent().append(html);
          index=index+1;
     });
      $("#delButton").click(function(){
             if(index >0 ){
                 $(this).parent().children().last().remove();
                 index=index-1;
             }
      });

</script>