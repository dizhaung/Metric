<div class="ibox-content">
    <form class="form-inline" id="jobForm">
        <div class="form-group">
            <label>JOB名称:</label>
            <select name="jobCode" class="form-control" style="width:130px;height:33px">
                <option value="">全部</option>
                #foreach(${_job} in ${jobList})
                <option value="$!{_job.value}" hassubinfo="true">$!{_job.name}</option>
                #end
            </select>
            <label>状态:</label>
            <select name="state" class="form-control" style="width:130px;height:33px">
                <option value="-99">全部</option>
                <option value="0" hassubinfo="true">待运行</option>
                <option value="1" hassubinfo="true">执行中</option>
                <option value="9" hassubinfo="true">执行成功</option>
                <option value="-9" hassubinfo="true">执行失败</option>
            </select>
            <label>账期:</label>
            <input class="form-control layer-date" name="createdAtStart" id="createdAtStart" placeholder="开始时间"
                   onclick="laydate({istime: true, format: 'YYYY-MM-DD'})">
            -<input class="form-control layer-date" name="createdAtEnd" id="createdAtEnd" placeholder="结束时间"
                    onclick="laydate({istime: true, format: 'YYYY-MM-DD'})">
        </div>
        <br><br>
        <div class="form-group">
            <button class="btn btn-white" type="button" onclick="searchList('1')"><i class="glyphicon glyphicon-search"></i>查询</button>
            <!--<button class="btn btn-success" type="button" onclick="add()"><i class="glyphicon glyphicon-plus"></i>创建业务目标</button>-->
        </div>
    </form>
</div>
<div class="jqGrid_wrapper">
    <table id="table_list_1"></table>
    <div id="pager_list_1"></div>
</div>
<script>
  function searchList(page){
       $("#table_list_1").jqGrid('setGridParam',{
            url:'queryJobInst.html',
            postData: getParams(),
            page:page
       }).trigger("reloadGrid");
   }
   $(document).ready(function () {
       $.jgrid.defaults.styleUI = 'Bootstrap';
       $('#table_list_1').jqGrid({
              url:'queryJobInst.html',
              datatype: "json",
              postData: getParams(),
              height: jqGridHeight,
              autowidth: true,
              shrinkToFit: true,
              viewrecords:true,
              rowNum: 20,
              rowList: [20, 30, 50],
              viewrecords : true,
              colNames: ['JOB编码','类型','名称','间隔（分钟）','账期','状态','同步数据量','备注','运行时间','完成时间','操作'],
              colModel: [
                 {
                   name: 'jobCode',
                   width: 10
                 },
                 {
                    name: 'jobType',
                    width: 10
                 },
                 {
                       name: 'jobName',
                       width: 10
                  },
                  {
                      name: 'particleSize',
                      width: 10
                  },
                   {
                      name: 'circleTime',
                      width: 12,
                      formatter:formatDate
                    },
                  {
                    name: 'state',
                    width: 10,
                    formatter:function(cellvalue){
                        if(cellvalue=='0')
                            return "待运行";
                        else if(cellvalue=='1')
                            return "执行中";
                        else if(cellvalue=='9')
                            return "执行成功";
                        else if(cellvalue=='-9')
                            return "执行失败";
                        else
                            return cellvalue;
                    }
                  },
                  {
                    name: 'syncNbr',
                    width: 10
                  },
                  {
                    name: 'remark',
                    width: 10
                  },
                  {
                    name: 'runDate',
                    width: 10,
                    formatter:formatDate
                  },
                  {
                    name: 'completeDate',
                    width: 10,
                    formatter:formatDate
                  },
                  {
                   name:'state',
                   width:10,
                   formatter : function(value, options, rowObject) {
                        if(value==9||value==-9){
                            var b = '<a onclick="recoveryTask(\'' + rowObject.jobCode + '\',\'' + rowObject.circleTime + '\')" class="btn btn-danger "><i class="glyphicon glyphicon-ok-circle"></i>重做任务</a>';
                            return b;
                        }
                        return "";
                    }
                  }
              ],
              pager: "#pager_list_1"
         });
   });
 function recoveryTask(jobCode, circleTime){
           layer.confirm('确认执行该操作？',{icon: 3, title:'重做任务'}, function(){
           $.ajax({
                 type: "POST",
                 url:"recoveryTask.html?jobCode="+jobCode + "&circleTime=" + circleTime,
                 dataType:"json",
                 success: function(data) {
                    if(data.code == 1){
                       searchList();
                       closeLayer(data.msg);
                    }else{
                       layer.msg(data.msg,failIcon);
                   }
                }
            });
           }, function(){
            layer.closeAll();
          });
        }
   function getParams(){
        var data=$('#jobForm').serialize();
        data= decodeURIComponent(data,true);
        return formToJson(data);
    }
   function formToJson(data) {
       data=data.replace(/&/g,"\",\"");
       data=data.replace(/=/g,"\":\"");
       data="{\""+data+"\"}";
       var json =  eval('(' + data + ')');
       return json;
    }
    function formatDate(cellvalue)   {
      var date = new Date(cellvalue);
        var y = date.getFullYear();
        var m = date.getMonth() + 1;
        m = m < 10 ? ('0' + m) : m;
        var d = date.getDate();
        d = d < 10 ? ('0' + d) : d;
        var h = date.getHours();
        h = h < 10 ? ('0' + h) : h;
        var minute = date.getMinutes();
        var second = date.getSeconds();
        minute = minute < 10 ? ('0' + minute) : minute;
        second = second < 10 ? ('0' + second) : second;
        return y + '-' + m + '-' + d+' '+h+':'+minute+':'+second;
    }
</script>